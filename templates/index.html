<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE Stock Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 20px; }
        .stock-table { background: white; border-radius: 8px; }
        .alert-item { margin: 10px 0; }
        .status-badge { padding: 5px 10px; border-radius: 4px; }
        .status-active { background-color: #28a745; color: white; }
        .status-inactive { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">NSE Stock Monitor</h1>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Monitored Stocks</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped" id="stockTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Current Price</th>
                                    <th>Upper Limit</th>
                                    <th>Lower Limit</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="stocks">
                                <tr><td colspan="5" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Add Stock</h5>
                    </div>
                    <div class="card-body">
                        <form id="addStockForm">
                            <div class="mb-3">
                                <label>Symbol</label>
                                <input type="text" class="form-control" id="symbol" required>
                            </div>
                            <div class="mb-3">
                                <label>Upper Limit</label>
                                <input type="number" class="form-control" id="upper_limit" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label>Lower Limit</label>
                                <input type="number" class="form-control" id="lower_limit" step="0.01">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add Stock</button>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Controls</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" id="startBtn">Start Monitoring</button>
                        <button class="btn btn-danger w-100 mb-2" id="stopBtn">Stop Monitoring</button>
                        <button class="btn btn-info w-100" id="refreshBtn">Refresh Prices</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Alerts</h5>
            </div>
            <div class="card-body" id="alerts" style="max-height: 300px; overflow-y: auto;">
                <p class="text-muted">No alerts yet</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@latest/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();

        // Load stocks on page load
        function loadStocks() {
            fetch('/api/stocks')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('stocks');
                    if (Object.keys(data).length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No stocks added</td></tr>';
                        return;
                    }
                    tbody.innerHTML = Object.values(data).map(stock => `
                        <tr>
                            <td>${stock.symbol}</td>
                            <td>${stock.current_price ? 'â‚¹' + stock.current_price.toFixed(2) : 'N/A'}</td>
                            <td>${stock.upper_limit || 'N/A'}</td>
                            <td>${stock.lower_limit || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="removeStock('${stock.symbol}')">Remove</button>
                            </td>
                        </tr>
                    `).join('');
                });
        }

        // Add stock
        document.getElementById('addStockForm').addEventListener('submit', (e) => {
            e.preventDefault();
            fetch('/api/stocks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: document.getElementById('symbol').value,
                    upper_limit: parseFloat(document.getElementById('upper_limit').value) || null,
                    lower_limit: parseFloat(document.getElementById('lower_limit').value) || null
                })
            }).then(() => {
                loadStocks();
                document.getElementById('addStockForm').reset();
            });
        });

        // Remove stock
        function removeStock(symbol) {
            fetch(`/api/stocks/${symbol}`, { method: 'DELETE' })
                .then(() => loadStocks());
        }

        // Control buttons
        document.getElementById('startBtn').onclick = () => fetch('/api/monitoring/start', { method: 'POST' });
        document.getElementById('stopBtn').onclick = () => fetch('/api/monitoring/stop', { method: 'POST' });
        document.getElementById('refreshBtn').onclick = () => socket.emit('refresh_prices');

        // Socket events
        socket.on('price_update', (data) => loadStocks());
        socket.on('alert', (data) => {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = `<div class="alert alert-warning alert-item">${data.symbol}: ${data.message}</div>` + alertsDiv.innerHTML;
        });

        loadStocks();
    </script>
</body>
</html>
